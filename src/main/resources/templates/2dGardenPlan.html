<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/header.html}">
    <title>Konva Grid Demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
    </style>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
</head>
<body>
<div id="container" class="justify-content-center"></div>
<div>
<script>
    var stageWidth = window.innerWidth;
    var stageHeight = window.innerHeight;
    var GRID_SIZE = 100;  // Size of each grid cell
    var GRID_COLUMNS = 10;  // Number of columns in the grid
    var GRID_ROWS = 10;  // Number of rows in the grid

    // Calculate the total grid width and height
    var gridWidth = GRID_COLUMNS * GRID_SIZE;
    var gridHeight = GRID_ROWS * GRID_SIZE;

    // Calculate the offsets to center the grid
    var offsetX = (stageWidth - gridWidth) / 2;
    var offsetY = (stageHeight - gridHeight) / 2;

    var stage = new Konva.Stage({
        container: 'container',
        width: stageWidth,
        height: stageHeight,
    });

    var layer = new Konva.Layer();
    stage.add(layer);

    // Create a grid of squares
    for (var i = 0; i < GRID_COLUMNS; i++) {
        for (var j = 0; j < GRID_ROWS; j++) {
            var rect = new Konva.Rect({
                x: i * GRID_SIZE + offsetX,
                y: j * GRID_SIZE + offsetY,
                width: GRID_SIZE,
                height: GRID_SIZE,
                fill: 'green',
                stroke: 'black',
                strokeWidth: 1,
                name: 'grid-cell',
            });
            layer.add(rect);
        }
    }

    var plantImage = new Image();
    plantImage.src = 'https://perenual.com/storage/species_image/5833_petroselinum_crispum/og/24890552915_bc32127f01_b.jpg';  // Replace with your image path

    plantImage.onload = function() {
        var plant = new Konva.Image({
            x: offsetX + 20,
            y: offsetY + 20,
            image: plantImage,
            width: GRID_SIZE,
            height: GRID_SIZE,
            draggable: true,
            name: 'plant',
        });
        layer.add(plant);

        // Snap the image to the grid on drag
        plant.on('dragmove', function () {
            var x = Math.round((plant.x() - offsetX) / GRID_SIZE) * GRID_SIZE + offsetX;
            var y = Math.round((plant.y() - offsetY) / GRID_SIZE) * GRID_SIZE + offsetY;

            plant.position({
                x: x,
                y: y,
            });
        });

        plant.on('click', function () {
            selected = true;
            plant.stroke('blue');  // Highlight the selected plant
            plant.strokeWidth(4);
            layer.draw();
        });

        stage.on('click', function (e) {
            if (selected && !e.target.hasName('plant')) {
                var mousePos = stage.getPointerPosition();
                var x = Math.floor((mousePos.x - offsetX) / GRID_SIZE) * GRID_SIZE + offsetX;
                var y = Math.floor((mousePos.y - offsetY) / GRID_SIZE) * GRID_SIZE + offsetY;

                plant.position({
                    x: x,
                    y: y,
                });

                plant.stroke(null);  // Remove highlight after placement
                plant.strokeWidth(0);
                layer.draw();
                selected = false;  // Deselect after placing
            }
        });

        layer.draw();
    };
</script>
</div>
</body>
</html>
